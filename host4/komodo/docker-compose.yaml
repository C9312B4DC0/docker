###################################
# ðŸ¦Ž KOMODO COMPOSE - FERRETDB ðŸ¦Ž #
###################################

## This compose file will deploy:
##   1. Postgres + FerretDB Mongo adapter (https://www.ferretdb.com)
##   2. Komodo Core
##   3. Komodo Periphery (CREATED AS SYSTEMD, CONFIG AT /home/conadmin/.config/komodo/periphery.config.toml)

services:
  postgres:
    # ðŸš¨ Pin to a specific version. Updates can be breaking.
    # https://github.com/FerretDB/documentdb/pkgs/container/postgres-documentdb
    image: ghcr.io/ferretdb/postgres-documentdb:${POSTGRESS_IMAGE_VERSION}
    labels:
      komodo.skip: # Prevent Komodo from stopping with StopAllContainers
    restart: unless-stopped
    ports:
      - ${POSTGRES_HOST_PORT}:${POSTGRES_CONTAINER_PORT}
    volumes:
      - ${POSTGRES_DATA_PATH}/data:/var/lib/postgresql/data
    env_file: ./.env
    environment:
      POSTGRES_USER: ${KOMODO_DB_USERNAME}
      POSTGRES_PASSWORD: ${KOMODO_DB_PASSWORD}
      POSTGRES_DB: postgres

  ferretdb:
    # ðŸš¨ Pin to a specific version. Updates can be breaking.
    # https://github.com/FerretDB/FerretDB/pkgs/container/ferretdb
    image: ghcr.io/ferretdb/ferretdb:${FERRETDB_IMAGE_VERSION}
    labels:
      komodo.skip: # Prevent Komodo from stopping with StopAllContainers
    restart: unless-stopped
    depends_on:
      - postgres
    ports:
      - ${FERRETDB_HOST_PORT}:${FERRETDB_CONTAINER_PORT}
    volumes:
      - ${FERRETDB_DATA_PATH}/state:/state
    env_file: ./.env
    environment:
      FERRETDB_POSTGRESQL_URL: postgres://${KOMODO_DB_USERNAME}:${KOMODO_DB_PASSWORD}@postgres:${POSTGRES_HOST_PORT}/postgres

  core:
    image: ghcr.io/moghtech/komodo-core:${KOMODO_IMAGE_VERSION}
    labels:
      komodo.skip: # Prevent Komodo from stopping with StopAllContainers
    restart: unless-stopped
    depends_on:
      - ferretdb
    ports:
      - ${KOMODO_HOST_PORT}:${KOMODO_CONTAINER_PORT}
    env_file: ./.env
    environment:
      KOMODO_DATABASE_ADDRESS: ferretdb:${FERRETDB_HOST_PORT}
      KOMODO_DATABASE_USERNAME: ${KOMODO_DB_USERNAME}
      KOMODO_DATABASE_PASSWORD: ${KOMODO_DB_PASSWORD}
    volumes:
      ## Store dated backups of the database - https://komo.do/docs/setup/backup
      - ${KOMODO_DATA_PATH}/backups:/backups
      ## Store sync files on server
      - ${KOMODO_DATA_PATH}/syncs:/syncs
      ## Optionally mount a custom core.config.toml
      # - /path/to/core.config.toml:/config/config.toml
    ## Allows for systemd Periphery connection at
    ## "https://host.docker.internal:8120"
    # extra_hosts:
    #   - host.docker.internal:host-gateway

